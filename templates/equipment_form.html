{% extends "base.html" %}

{% block title %}{% if equipment %}Edit{% else %}Add{% endif %} Equipment - GearGuard{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{% if equipment %}Edit{% else %}Add New{% endif %} Equipment</h2>
</div>

<div class="form-container">
    <form method="POST" class="entity-form">
        <div class="form-row">
            <div class="form-group">
                <label for="equipment_name">Equipment Name *</label>
                <input type="text" id="equipment_name" name="equipment_name" value="{{ equipment.equipment_name if equipment else '' }}" required>
            </div>
            
            <div class="form-group">
                <label for="serial_number">Serial Number *</label>
                <input type="text" id="serial_number" name="serial_number" value="{{ equipment.serial_number if equipment else '' }}" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="department">Department</label>
                <input type="text" id="department" name="department" value="{{ equipment.department if equipment else '' }}">
            </div>
            
            <div class="form-group">
                <label for="assigned_employee">Assigned Employee</label>
                <input type="text" id="assigned_employee" name="assigned_employee" value="{{ equipment.assigned_employee if equipment else '' }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="purchase_date">Purchase Date</label>
                <input type="date" id="purchase_date" name="purchase_date" value="{{ equipment.purchase_date.strftime('%Y-%m-%d') if equipment and equipment.purchase_date else '' }}">
            </div>
            
            <div class="form-group">
                <label for="warranty_expiry">Warranty Expiry</label>
                <input type="date" id="warranty_expiry" name="warranty_expiry" value="{{ equipment.warranty_expiry.strftime('%Y-%m-%d') if equipment and equipment.warranty_expiry else '' }}">
            </div>
        </div>

        <div class="form-group">
            <label for="location">Location *</label>
            <input type="text" id="location" name="location" value="{{ equipment.location if equipment else '' }}" required>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="maintenance_team_id">Maintenance Team *</label>
                <select id="maintenance_team_id" name="maintenance_team_id" required onchange="loadTechnicians(this.value)">
                    <option value="">Select Team</option>
                    {% for team in teams %}
                    <option value="{{ team.id }}" {% if equipment and equipment.maintenance_team_id == team.id %}selected{% endif %}>
                        {{ team.team_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="default_technician_id">Default Technician</label>
                <select id="default_technician_id" name="default_technician_id">
                    <option value="">Select Technician</option>
                </select>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">Save Equipment</button>
            <a href="{{ url_for('equipment.list_equipment') }}" class="btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
const defaultTechnicianId = JSON.parse('{{ equipment.default_technician_id|tojson if equipment and equipment.default_technician_id else "null" }}');

function loadTechnicians(teamId) {
    const techSelect = document.getElementById('default_technician_id');
    techSelect.innerHTML = '<option value="">Select Technician</option>';
    
    if (teamId) {
        fetch(`/equipment/api/technicians/${teamId}`)
            .then(response => response.json())
            .then(technicians => {
                technicians.forEach(tech => {
                    const option = document.createElement('option');
                    option.value = tech.id;
                    option.textContent = tech.name;

                    if (defaultTechnicianId !== null && String(tech.id) === String(defaultTechnicianId)) {
                        option.selected = true;
                    }

                    techSelect.appendChild(option);
                });
            });
    }
}

// Load technicians on page load if team is selected
window.addEventListener('DOMContentLoaded', function() {
    const teamSelect = document.getElementById('maintenance_team_id');
    if (teamSelect.value) {
        loadTechnicians(teamSelect.value);
    }
});
</script>
{% endblock %}
        